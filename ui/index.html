<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThinkingWithoutThinking - AI Reasoning Pipeline</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #111113;
            --bg-tertiary: #18181b;
            --bg-elevated: #1f1f23;
            --border-subtle: #27272a;
            --border-default: #3f3f46;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --accent-primary: #8b5cf6;
            --accent-secondary: #a78bfa;
            --accent-gradient: linear-gradient(135deg, #8b5cf6 0%, #6366f1 50%, #3b82f6 100%);
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.4);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.5);
            --shadow-lg: 0 12px 40px rgba(0,0,0,0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Layout */
        .app-container {
            display: grid;
            grid-template-columns: 320px 1fr 300px;
            min-height: 100vh;
        }

        /* Left Sidebar - Input */
        .sidebar-left {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: sticky;
            top: 0;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--accent-gradient);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .logo-text h1 {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .logo-text span {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .input-area {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        textarea {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            padding: 14px;
            resize: none;
            transition: all 0.2s ease;
            min-height: 200px;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
        }

        textarea::placeholder {
            color: var(--text-muted);
        }

        .select-wrapper {
            position: relative;
        }

        select {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            padding: 12px 14px;
            cursor: pointer;
            appearance: none;
            transition: all 0.2s ease;
        }

        select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .select-wrapper::after {
            content: '‚ñæ';
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        .btn {
            background: var(--accent-gradient);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 600;
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
        }

        .btn-secondary:hover {
            background: var(--bg-elevated);
            box-shadow: none;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .main-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-dot.active {
            background: var(--success);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pipeline-view {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        /* Pipeline Steps */
        .pipeline-step {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .pipeline-step.active {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .pipeline-step.error {
            border-color: var(--error);
        }

        .step-header {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            user-select: none;
        }

        .step-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: var(--bg-tertiary);
        }

        .step-icon.planning { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
        .step-icon.critique { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
        .step-icon.routing { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
        .step-icon.tool { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .step-icon.synthesis { background: rgba(236, 72, 153, 0.15); color: #ec4899; }
        .step-icon.complete { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .step-icon.error { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

        .step-info {
            flex: 1;
        }

        .step-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .step-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .step-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .step-status.running {
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent-secondary);
        }

        .step-status.complete {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .step-content {
            padding: 0 20px 20px 68px;
            display: none;
        }

        .step-content.expanded {
            display: block;
        }

        .step-content pre {
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
            color: var(--text-secondary);
            max-height: 400px;
            overflow-y: auto;
        }

        /* Final Response */
        .final-response {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
            border: 1px solid var(--accent-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-top: 8px;
        }

        .final-response h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .final-response .response-content {
            font-size: 15px;
            line-height: 1.8;
            color: var(--text-primary);
            white-space: pre-wrap;
        }

        .final-response .response-content p {
            margin-bottom: 1em;
        }

        .final-response .response-content strong {
            color: var(--accent-secondary);
            font-weight: 600;
        }

        .final-response .response-content ul,
        .final-response .response-content ol {
            margin-left: 1.5em;
            margin-bottom: 1em;
        }

        .final-response .response-content li {
            margin-bottom: 0.5em;
        }

        .final-response .response-content code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }

        /* Right Sidebar - Stats */
        .sidebar-right {
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-subtle);
            padding: 24px 20px;
            height: 100vh;
            position: sticky;
            top: 0;
            overflow-y: auto;
        }

        .stats-section {
            margin-bottom: 24px;
        }

        .stats-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 12px;
        }

        .stat-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 14px;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-value.small {
            font-size: 14px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-mini {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 10px;
            text-align: center;
        }

        .stat-mini .stat-value {
            font-size: 16px;
        }

        .stat-mini .stat-label {
            font-size: 10px;
        }

        /* Tool Errors Alert */
        .tool-errors {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            border-radius: var(--radius-md);
            padding: 14px;
            margin-bottom: 16px;
        }

        .tool-errors h4 {
            color: var(--error);
            font-size: 13px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tool-errors ul {
            list-style: none;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .tool-errors li {
            padding: 4px 0;
        }

        /* Dev Actions */
        .dev-actions {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid var(--border-subtle);
        }

        .dev-actions .btn {
            width: 100%;
            margin-bottom: 8px;
            font-size: 12px;
            padding: 10px;
        }

        /* Loading States */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-default);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
            padding: 40px;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 14px;
            max-width: 300px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 280px 1fr;
            }
            .sidebar-right {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
            }
            .sidebar-left {
                position: relative;
                height: auto;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-default);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar -->
        <aside class="sidebar-left">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">üß†</div>
                    <div class="logo-text">
                        <h1>ThinkingWithoutThinking</h1>
                        <span>AI Reasoning Pipeline</span>
                    </div>
                </div>
            </div>
            
            <div class="input-area">
                <div class="input-group">
                    <label class="input-label">Your Prompt</label>
                    <textarea id="prompt-input" placeholder="Ask me anything... I'll think through it step by step."></textarea>
                </div>
                
                <div class="input-group">
                    <label class="input-label">Thinking Level</label>
                    <div class="select-wrapper">
                        <select id="thinking-level">
                            <option value="low">Low - Quick response</option>
                            <option value="medium_synth" selected>Medium - With synthesis</option>
                            <option value="medium_plan">Medium - With planning</option>
                            <option value="high">High - Full reasoning</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn" id="submit-btn" onclick="submitPrompt()">
                    <span>üöÄ</span> Generate Response
                </button>
                
                <button class="btn btn-secondary" onclick="clearOutput()">
                    Clear Output
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <div class="status-indicator">
                    <div class="status-dot" id="status-dot"></div>
                    <span id="status-text">Ready</span>
                </div>
                <div id="timer" style="font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--text-muted);">
                    00:00.000
                </div>
            </header>

            <div class="pipeline-view" id="pipeline-output">
                <div class="empty-state" id="empty-state">
                    <div class="empty-state-icon">üí≠</div>
                    <h3>Ready to Think</h3>
                    <p>Enter a prompt and I'll walk you through my reasoning process step by step.</p>
                </div>
            </div>
        </main>

        <!-- Right Sidebar -->
        <aside class="sidebar-right">
            <div class="stats-section">
                <div class="stats-title">Session Stats</div>
                <div class="stat-card">
                    <div class="stat-label">Total Requests</div>
                    <div class="stat-value" id="stat-requests">0</div>
                </div>
                <div class="stat-grid">
                    <div class="stat-mini">
                        <div class="stat-value" id="stat-tokens-in">0</div>
                        <div class="stat-label">Tokens In</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-value" id="stat-tokens-out">0</div>
                        <div class="stat-label">Tokens Out</div>
                    </div>
                </div>
            </div>

            <div class="stats-section">
                <div class="stats-title">Cost Tracking</div>
                <div class="stat-card">
                    <div class="stat-label">Session Cost (est.)</div>
                    <div class="stat-value" id="stat-cost">$0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Latency</div>
                    <div class="stat-value small" id="stat-latency">-- ms</div>
                </div>
            </div>

            <div class="stats-section" id="tool-errors-section" style="display: none;">
                <div class="tool-errors">
                    <h4>‚ö†Ô∏è Tool Errors</h4>
                    <ul id="tool-errors-list"></ul>
                </div>
            </div>

            <div class="dev-actions">
                <div class="stats-title">Developer</div>
                <button class="btn btn-secondary" onclick="reloadPrompts()">
                    üîÑ Reload Prompts
                </button>
                <button class="btn btn-secondary" onclick="fetchCostStats()">
                    üìä Refresh Stats
                </button>
            </div>
        </aside>
    </div>

    <script>
        let sessionRequests = 0;
        let timerInterval = null;
        let startTime = null;

        // Icon mapping for step types
        const stepIcons = {
            planning: 'üìù',
            plan: 'üìã',
            critique: 'üîç',
            plan_critique: 'üîç',
            improvement: '‚ú®',
            plan_improved: '‚ú®',
            routing: 'üîÄ',
            routed: 'üîÄ',
            tool_start: '‚öôÔ∏è',
            tool_complete: '‚úÖ',
            tool_error: '‚ùå',
            synthesizing: 'üîÆ',
            response: 'üí¨',
            final_critique: 'üîç',
            final_improvement: '‚ú®',
            final_response: 'üéØ',
            complete: '‚úÖ',
            error: '‚ùå',
            warning: '‚ö†Ô∏è'
        };

        const stepTitles = {
            planning: 'Generating Plan',
            plan: 'Plan Generated',
            critique: 'Self Critique',
            plan_critique: 'Plan Critique',
            improvement: 'Improving Plan',
            plan_improved: 'Plan Improved',
            routing: 'Routing to Tools',
            routed: 'Tools Selected',
            tool_start: 'Tool Starting',
            tool_complete: 'Tool Complete',
            tool_error: 'Tool Failed',
            synthesizing: 'Synthesizing Response',
            response: 'Initial Response',
            final_critique: 'Final Critique',
            final_improvement: 'Final Improvement',
            final_response: 'Final Response',
            complete: 'Complete',
            error: 'Error',
            warning: 'Warning'
        };

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                const ms = elapsed % 1000;
                document.getElementById('timer').textContent = 
                    `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(ms).padStart(3, '0')}`;
            }, 50);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function setStatus(text, active = false) {
            document.getElementById('status-text').textContent = text;
            const dot = document.getElementById('status-dot');
            if (active) {
                dot.classList.add('active');
            } else {
                dot.classList.remove('active');
            }
        }

        function clearOutput() {
            document.getElementById('pipeline-output').innerHTML = `
                <div class="empty-state" id="empty-state">
                    <div class="empty-state-icon">üí≠</div>
                    <h3>Ready to Think</h3>
                    <p>Enter a prompt and I'll walk you through my reasoning process step by step.</p>
                </div>
            `;
            document.getElementById('tool-errors-section').style.display = 'none';
            setStatus('Ready', false);
            stopTimer();
            document.getElementById('timer').textContent = '00:00.000';
        }

        function createStep(type, title, subtitle = '', content = '', isActive = false) {
            const iconClass = type.split('_')[0];
            const step = document.createElement('div');
            step.className = `pipeline-step ${isActive ? 'active' : ''} ${type === 'error' ? 'error' : ''}`;
            step.innerHTML = `
                <div class="step-header" onclick="this.nextElementSibling.classList.toggle('expanded')">
                    <div class="step-icon ${iconClass}">${stepIcons[type] || 'üìå'}</div>
                    <div class="step-info">
                        <div class="step-title">${title}</div>
                        ${subtitle ? `<div class="step-subtitle">${subtitle}</div>` : ''}
                    </div>
                    <div class="step-status ${isActive ? 'running' : 'complete'}">${isActive ? 'Running...' : 'Done'}</div>
                </div>
                <div class="step-content ${content ? 'expanded' : ''}">
                    <pre>${escapeHtml(content)}</pre>
                </div>
            `;
            return step;
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') {
                text = JSON.stringify(text, null, 2);
            }
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Simple markdown to HTML converter
        function renderMarkdown(text) {
            if (typeof text !== 'string') {
                text = JSON.stringify(text, null, 2);
            }
            
            // Escape HTML first
            let html = escapeHtml(text);
            
            // Convert **bold** to <strong>
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Convert *italic* to <em>
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            
            // Convert `code` to <code>
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Convert newlines to <br> for proper line breaks
            html = html.replace(/\n/g, '<br>');
            
            // Convert double line breaks to paragraph breaks
            html = html.replace(/<br><br>/g, '</p><p>');
            
            return '<p>' + html + '</p>';
        }

        function showFinalResponse(response) {
            // Remove any existing final response
            const existing = document.querySelector('.final-response');
            if (existing) existing.remove();
            
            const container = document.createElement('div');
            container.className = 'final-response';
            container.innerHTML = `
                <h3>üéØ Final Response</h3>
                <div class="response-content">${renderMarkdown(response)}</div>
            `;
            document.getElementById('pipeline-output').appendChild(container);
            
            // Mark all steps as complete
            document.querySelectorAll('.pipeline-step.active').forEach(step => {
                step.classList.remove('active');
                const statusEl = step.querySelector('.step-status');
                if (statusEl) {
                    statusEl.classList.remove('running');
                    statusEl.classList.add('complete');
                    statusEl.textContent = 'Done';
                }
            });
        }

        function showToolErrors(errors) {
            if (!errors || errors.length === 0) return;
            
            const section = document.getElementById('tool-errors-section');
            const list = document.getElementById('tool-errors-list');
            list.innerHTML = errors.map(e => 
                `<li><strong>${e.tool_id}</strong>: ${e.error} (${e.attempts} attempts)</li>`
            ).join('');
            section.style.display = 'block';
        }

        async function submitPrompt() {
            const prompt = document.getElementById('prompt-input').value.trim();
            const thinkingLevel = document.getElementById('thinking-level').value;
            
            if (!prompt) {
                alert('Please enter a prompt');
                return;
            }

            // Clear previous output
            const output = document.getElementById('pipeline-output');
            output.innerHTML = '';
            document.getElementById('tool-errors-section').style.display = 'none';

            // Update UI state
            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Processing...';
            setStatus('Processing', true);
            startTimer();

            sessionRequests++;
            document.getElementById('stat-requests').textContent = sessionRequests;

            try {
                const response = await fetch('/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, thinking_level: thinkingLevel })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                handleEvent(data);
                            } catch (e) {
                                console.error('Parse error:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                const step = createStep('error', 'Connection Error', '', error.message);
                output.appendChild(step);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>üöÄ</span> Generate Response';
                setStatus('Complete', false);
                stopTimer();
            }
        }

        function handleEvent(data) {
            const output = document.getElementById('pipeline-output');
            const type = data.type;

            // Mark all previous active steps as complete
            document.querySelectorAll('.pipeline-step.active').forEach(step => {
                step.classList.remove('active');
                const statusEl = step.querySelector('.step-status');
                if (statusEl) {
                    statusEl.classList.remove('running');
                    statusEl.classList.add('complete');
                    statusEl.textContent = 'Done';
                }
            });

            switch (type) {
                case 'planning':
                case 'critique':
                case 'improvement':
                case 'routing':
                case 'synthesizing':
                case 'final_critique':
                case 'final_improvement':
                    output.appendChild(createStep(type, stepTitles[type], data.message || '', '', true));
                    break;

                case 'plan':
                case 'plan_improved':
                    output.appendChild(createStep(type, stepTitles[type], '', data.plan));
                    break;

                case 'plan_critique':
                case 'final_critique_complete':
                    output.appendChild(createStep('critique', 'Critique Complete', '', data.critique));
                    break;

                case 'routed':
                    const toolList = (data.tools || []).map(t => t.tool_id).join(', ') || 'None';
                    output.appendChild(createStep(type, stepTitles[type], `Tools: ${toolList}`, JSON.stringify(data.tools, null, 2)));
                    break;

                case 'tool_start':
                    output.appendChild(createStep(type, `Starting: ${data.tool_id}`, data.description || '', '', true));
                    break;

                case 'tool_complete':
                    const result = typeof data.result === 'string' ? data.result : JSON.stringify(data.result, null, 2);
                    output.appendChild(createStep(type, `${data.tool_id} Complete`, '', result.substring(0, 1000)));
                    break;

                case 'tool_error':
                    output.appendChild(createStep(type, `${data.tool_id} Failed`, '', data.error));
                    break;

                case 'response':
                    output.appendChild(createStep(type, stepTitles[type], '', data.response));
                    break;

                case 'final_response':
                    showFinalResponse(data.response);
                    break;

                case 'complete':
                    if (data.final) {
                        if (data.final.tool_errors && data.final.tool_errors.length > 0) {
                            showToolErrors(data.final.tool_errors);
                        }
                        if (data.final.response && !document.querySelector('.final-response')) {
                            showFinalResponse(data.final.response);
                        }
                    }
                    break;

                case 'error':
                    output.appendChild(createStep('error', 'Error', '', data.message));
                    break;

                case 'warning':
                    output.appendChild(createStep('warning', 'Warning', '', data.message));
                    break;
            }

            // Auto-scroll to bottom
            output.scrollTop = output.scrollHeight;
        }

        async function reloadPrompts() {
            try {
                const response = await fetch('/reload-prompts', { method: 'POST' });
                const data = await response.json();
                if (data.status === 'ok') {
                    alert(`Prompts reloaded! Found ${data.prompt_count} prompts: ${data.prompt_ids.join(', ')}`);
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                alert('Failed to reload prompts: ' + error.message);
            }
        }

        async function fetchCostStats() {
            try {
                const response = await fetch('/cost-stats');
                const data = await response.json();
                if (data.status === 'ok') {
                    const session = data.session;
                    document.getElementById('stat-tokens-in').textContent = session.total_input_tokens.toLocaleString();
                    document.getElementById('stat-tokens-out').textContent = session.total_output_tokens.toLocaleString();
                    document.getElementById('stat-cost').textContent = `$${session.estimated_cost.toFixed(4)}`;
                    document.getElementById('stat-latency').textContent = `${session.average_latency_ms.toFixed(0)} ms`;
                }
            } catch (error) {
                console.error('Failed to fetch cost stats:', error);
            }
        }

        // Keyboard shortcut: Ctrl/Cmd + Enter to submit
        document.getElementById('prompt-input').addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                submitPrompt();
            }
        });

        // Fetch initial stats
        fetchCostStats();
        setInterval(fetchCostStats, 10000); // Refresh every 10 seconds
    </script>
</body>
</html>
